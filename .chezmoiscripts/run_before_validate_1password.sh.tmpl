#!/usr/bin/env bash
set -euo pipefail

# Validate 1Password CLI is available and unlocked before chezmoi apply

if ! command -v op &>/dev/null; then
    echo "ERROR: 1Password CLI (op) is not installed."
    echo "Install it from: https://developer.1password.com/docs/cli/get-started/"
    exit 1
fi

# Check if specific account is configured and signed in
if ! op account list 2>/dev/null | grep -q "{{ .op.address }}"; then
    echo "ERROR: 1Password account {{ .op.address }} is not configured."
    echo ""
    echo "To fix this, run:"
    echo "  op account add --address {{ .op.address }}"
    echo ""
    echo "Then sign in:"
    echo "  eval \$(op signin --account {{ .op.address }})"
    exit 1
fi

if ! op account get --account "{{ .op.address }}" &>/dev/null; then
    echo "ERROR: 1Password account {{ .op.address }} is not signed in."
    echo ""
    echo "To fix this, run:"
    echo "  eval \$(op signin --account {{ .op.address }})"
    echo ""
    echo "Then retry: chezmoi apply"
    exit 1
fi

echo "1Password: {{ .op.address }} unlocked and ready"
