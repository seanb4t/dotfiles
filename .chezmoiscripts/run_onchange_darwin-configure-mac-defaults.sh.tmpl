{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

# mac-defaults.yaml hash: {{ include ".chezmoidata/mac-defaults.yaml" | sha256sum }}
# mac-power hash: {{ .mac_power | toJson | sha256sum }}

# Close System Preferences to prevent conflicts
osascript -e 'tell application "System Preferences" to quit' 2>/dev/null || true

###############################################################################
# User Defaults (from mac-defaults.yaml)                                       #
###############################################################################

{{- range $domain, $settings := .mac_defaults }}
{{- range $settings }}
defaults write {{ $domain }} {{ .name | quote }} -{{ .type }} {{ .value | quote }}
{{- end }}
{{- end }}

###############################################################################
# Time Machine                                                                 #
###############################################################################

# Prevent Time Machine from prompting to use new hard drives as backup volume
defaults write com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true

###############################################################################
# Spotlight                                                                    #
###############################################################################

# Configure search result ordering and disable some categories
defaults write com.apple.spotlight orderedItems -array \
	'{"enabled" = 1;"name" = "APPLICATIONS";}' \
	'{"enabled" = 1;"name" = "SYSTEM_PREFS";}' \
	'{"enabled" = 1;"name" = "DIRECTORIES";}' \
	'{"enabled" = 1;"name" = "PDF";}' \
	'{"enabled" = 1;"name" = "FONTS";}' \
	'{"enabled" = 0;"name" = "DOCUMENTS";}' \
	'{"enabled" = 0;"name" = "MESSAGES";}' \
	'{"enabled" = 0;"name" = "CONTACT";}' \
	'{"enabled" = 0;"name" = "EVENT_TODO";}' \
	'{"enabled" = 0;"name" = "IMAGES";}' \
	'{"enabled" = 0;"name" = "BOOKMARKS";}' \
	'{"enabled" = 0;"name" = "MUSIC";}' \
	'{"enabled" = 0;"name" = "MOVIES";}' \
	'{"enabled" = 0;"name" = "PRESENTATIONS";}' \
	'{"enabled" = 0;"name" = "SPREADSHEETS";}' \
	'{"enabled" = 0;"name" = "SOURCE";}' \
	'{"enabled" = 0;"name" = "MENU_DEFINITION";}' \
	'{"enabled" = 0;"name" = "MENU_OTHER";}' \
	'{"enabled" = 0;"name" = "MENU_CONVERSION";}' \
	'{"enabled" = 0;"name" = "MENU_EXPRESSION";}' \
	'{"enabled" = 0;"name" = "MENU_WEBSEARCH";}' \
	'{"enabled" = 0;"name" = "MENU_SPOTLIGHT_SUGGESTIONS";}'

###############################################################################
# System Settings (require sudo)                                               #
###############################################################################

# Ask for administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` timestamp until script has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Configure power settings
sudo pmset -c powermode {{ .mac_power.power_mode }}
sudo pmset -c sleep {{ .mac_power.sleep }}
sudo pmset -c disksleep {{ .mac_power.disksleep }}
sudo pmset -c displaysleep {{ .mac_power.displaysleep }}
sudo pmset -b lowpowermode {{ .mac_power.low_power_mode }}

# Configure sudo to allow touchid
if [[ ! -f /etc/pam.d/sudo_local ]]; then
    cat /etc/pam.d/sudo_local.template | sed -e 's/#auth/auth/g' | sudo tee /etc/pam.d/sudo_local
fi

# Restart Spotlight and rebuild index (may take time)
killall mds 2>/dev/null || true
sudo mdutil -i on / > /dev/null 2>&1 || echo "WARNING: Failed to enable Spotlight indexing"
sudo mdutil -E / > /dev/null 2>&1 || echo "WARNING: Failed to rebuild Spotlight index"

###############################################################################
# Restart affected applications                                                #
###############################################################################

killall Finder 2>/dev/null || true
killall Dock 2>/dev/null || true
killall Safari 2>/dev/null || true
killall SystemUIServer 2>/dev/null || true

{{- end }}
